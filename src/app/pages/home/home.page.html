<ion-header class="xolos-header">
  <ion-toolbar color="dark">
    <div class="hero">
      <div class="hero__avatar">
        <img src="assets/logo.png" alt="Logo Xolos RMZ" />
      </div>
      <div class="hero__content">
        <p class="eyebrow">XolosArmy</p>
        <h1>Xolos RMZ Wallet</h1>
        <p class="tagline">Tecnolog√≠a eCash para la naci√≥n rojinegra</p>
        <ng-container *ngIf="syncStatus$ | async as syncStatus">
          <span class="sync-pill" [class.connected]="syncStatus === 'synced'">
            üõ∞Ô∏è {{ statusText(syncStatus) }}
          </span>
        </ng-container>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="wallet-content">
  <ng-container *ngIf="state$ | async as state">
    <ng-container *ngIf="state.address; else walletSetup">
      <section class="card balance-card">
        <div class="balance-values">
          <div>
            <p class="label">Saldo eCash</p>
            <h2>{{ state.xecBalance | number: '1.2-2' }} XEC</h2>
          </div>
          <div>
            <p class="label">Saldo RMZ</p>
            <h2>{{ state.rmzBalanceFormatted }} RMZ</h2>
          </div>
        </div>
        <div class="address-shell">
          <div class="address-text">
            {{ (state.address | slice: 0:8) + '‚Ä¶' + (state.address | slice: -6) }}
          </div>
          <div class="address-actions">
            <ion-button size="small" fill="clear" color="light" (click)="copyAddress(state.address)">
              <ion-icon name="copy-outline" slot="start"></ion-icon>
              Copiar
            </ion-button>
            <ion-button size="small" fill="clear" color="light" (click)="toggleInlineQr()">
              <ion-icon name="qr-code" slot="start"></ion-icon>
              {{ showInlineQr ? 'Ocultar QR' : 'Mostrar QR' }}
            </ion-button>
          </div>
        </div>
        <div class="inline-qr" *ngIf="showInlineQr && qrDataUrl">
          <img [src]="qrDataUrl" alt="QR de la direcci√≥n" />
        </div>
        <div class="cta-buttons">
          <ion-button expand="block" color="danger" (click)="setSection('send')">
            <ion-icon name="paper-plane" slot="start"></ion-icon>
            Enviar
          </ion-button>
          <ion-button expand="block" fill="outline" color="light" (click)="setSection('receive')">
            <ion-icon name="qr-code" slot="start"></ion-icon>
            Recibir
          </ion-button>
        </div>
      </section>

      <section class="card receive-card" *ngIf="currentSection === 'receive'">
        <div class="section-header">
          <h3>Recibir fondos</h3>
          <ion-button fill="clear" size="small" (click)="setSection('overview')">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        <div class="qr-wrapper" *ngIf="qrDataUrl; else qrPlaceholder">
          <img [src]="qrDataUrl" alt="QR de la direcci√≥n" />
        </div>
        <ng-template #qrPlaceholder>
          <p class="muted">Generando c√≥digo QR‚Ä¶</p>
        </ng-template>
        <p class="address-full">{{ state.address }}</p>
        <ion-button size="small" fill="outline" color="light" (click)="copyAddress(state.address)">
          <ion-icon name="copy-outline" slot="start"></ion-icon>
          Copiar direcci√≥n
        </ion-button>
      </section>

      <section class="card action-card" *ngIf="currentSection === 'send'">
        <div class="section-header">
          <h3>Enviar fondos</h3>
          <ion-segment [(ngModel)]="selectedAsset" color="dark">
            <ion-segment-button value="XEC">
              <ion-label>XEC</ion-label>
            </ion-segment-button>
            <ion-segment-button value="RMZ">
              <ion-label>RMZ</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>
        <ion-list lines="none">
          <ion-item>
            <ion-label position="floating">Direcci√≥n destino</ion-label>
            <ion-input [(ngModel)]="sendToAddress" autocapitalize="none" autocomplete="off"></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Monto ({{ selectedAsset }})</ion-label>
            <ion-input type="number" [(ngModel)]="sendAmount"></ion-input>
          </ion-item>
        </ion-list>
        <div class="actions">
          <ion-button expand="block" color="danger" (click)="sendPayment()">
            <ion-icon name="rocket" slot="start"></ion-icon>
            Confirmar env√≠o
          </ion-button>
          <ion-button expand="block" fill="clear" (click)="setSection('overview')">Cerrar</ion-button>
        </div>
        <p class="status-msg" *ngIf="statusMessage">{{ statusMessage }}</p>
      </section>

      <section class="card history-card">
        <div class="section-header">
          <h3>Historial de movimientos</h3>
          <ion-button size="small" fill="clear" (click)="refreshHistory()">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Actualizar
          </ion-button>
        </div>
        <ng-container *ngIf="transactions$ | async as txs; else emptyHistory">
          <ion-list lines="none">
            <ion-item *ngFor="let tx of txs | slice: 0:10; trackBy: trackTx">
              <ion-label>
                <div class="tx-row">
                  <span class="badge" [class.in]="tx.direction === 'in'" [class.out]="tx.direction === 'out'">
                    {{ tx.direction === 'in' ? '‚ûï' : '‚ûñ' }}
                  </span>
                  <div class="tx-amounts">
                    <strong>{{ tx.xecAmount | number: '1.2-2' }} XEC</strong>
                    <span *ngIf="tx.tokenAmount">¬∑ {{ tx.tokenAmount }} RMZ</span>
                  </div>
                </div>
                <div class="tx-meta">
                  <span>{{ tx.timestamp | date: 'short' }}</span>
                  <span class="status-chip" [class.pending]="tx.status === 'pending'">
                    {{ tx.status === 'pending' ? '‚è≥ Pendiente' : '‚úÖ Confirmada' }}
                  </span>
                </div>
              </ion-label>
              <ion-note slot="end">{{ tx.txid | slice: 0:6 }}‚Ä¶{{ tx.txid | slice: -4 }}</ion-note>
            </ion-item>
          </ion-list>
        </ng-container>
        <ng-template #emptyHistory>
          <p class="muted">A√∫n no registramos movimientos. En cuanto recibas o env√≠es XEC aparecer√°n aqu√≠.</p>
        </ng-template>
      </section>
    </ng-container>

    <ng-template #walletSetup>
      <section class="card empty-wallet">
        <div class="empty-wallet__logo">
          <img src="assets/logo.png" alt="Logo Xolos RMZ" />
        </div>
        <h3>Activa tu Xolos RMZ Wallet</h3>
        <p>
          A√∫n no encontramos una cartera configurada en este dispositivo. Crea una nueva para empezar a
          recibir y enviar eCash y RMZ.
        </p>
        <ion-button color="danger" expand="block" (click)="createNewWallet()">
          <ion-icon name="shield-checkmark" slot="start"></ion-icon>
          Crear nueva cartera
        </ion-button>
      </section>
    </ng-template>
  </ng-container>
</ion-content>
